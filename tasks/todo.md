# Craftus - Instruction Image Generation Fix Plan

## Current Issue Analysis

### Problem Summary
The step instruction images generated by Gemini are not correctly matching the master reference image. The AI is generating generic craft images instead of precise, isolated step-by-step instruction images that match the exact style, colors, and materials from the master image.

### Root Causes Identified

#### 1. **Prompt Complexity Overload**
The `generateStepImage` function in [geminiService.ts](services/geminiService.ts) has an extremely long prompt (~200+ lines) that tries to:
- Explain multi-panel format
- Provide category-specific rules
- Include 3D unwrapping/UV mapping instructions
- Add material-specific construction rules
- Include "analysis before generation" steps

**Issue**: Gemini may be overwhelmed and not following the core instruction properly.

#### 2. **Reference Image Not Emphasized Enough**
While the master image is passed as `inlineData`, the prompt doesn't strongly anchor the AI to:
- Match EXACT colors from the reference
- Match EXACT textures from the reference
- Match EXACT style from the reference

The reference image is mentioned but buried among hundreds of other instructions.

#### 3. **Step Scope Confusion**
The prompt tells AI what NOT to include but doesn't clearly specify WHAT the step should show. Example:
- "If step is about body, show ONLY body pieces" - but doesn't say what "body pieces" look like for THIS craft

#### 4. **Category Rules Are Too Complex**
The `getCategorySpecificRules()` returns 100+ lines of rules per category (e.g., Papercraft). This dilutes the core instruction.

#### 5. **No Visual Consistency Enforcement**
There's no mechanism to ensure generated step images maintain visual consistency with:
- The master image
- Previously generated step images
- The craft's color palette

---

## Proposed Fixes

### Fix 1: Simplify and Focus the Step Image Prompt

**Before** (Current - Too Complex):
```
ðŸŽ¯ YOUR TASK: Create a MULTI-PANEL instructional image for this step: "${stepDescription}"
[200+ lines of instructions...]
```

**After** (Simplified):
```
REFERENCE IMAGE: Study this completed craft carefully. Your step image MUST match:
- EXACT colors (sample the RGB values)
- EXACT materials/textures
- EXACT style and aesthetic

TASK: Create an instruction image for Step ${stepNumber}: "${stepDescription}"

RULES:
1. Show ONLY components needed for THIS step (${stepDescription})
2. Use 2-4 panel layout with labels
3. Match reference image colors EXACTLY
4. White background, professional lighting
5. Include: Materials panel, Assembly panel, Result panel
```

### Fix 2: Add Color Palette Extraction

Before generating step images, extract the dominant colors from the master image and include them in the prompt:
```typescript
const colorPalette = await extractDominantColors(masterImageBase64);
// Returns: ["#FF5733", "#2E86AB", "#A23B72", ...]

// Then in prompt:
`COLOR PALETTE TO USE (from reference image): ${colorPalette.join(', ')}`
```

### Fix 3: Separate Category Rules from Core Prompt

Move category-specific rules to a separate, shorter context injection rather than embedding the full 100+ line rules in every prompt.

### Fix 4: Add Step Context Chain

Pass previous step information to maintain consistency:
```typescript
generateStepImage(
  masterImage,
  stepDescription,
  category,
  previousStepSummary, // NEW: "Step 1 created body. Step 2 added head."
  stepNumber
)
```

### Fix 5: Implement Two-Stage Generation

**Stage 1**: Generate a text description of what the step image should contain
**Stage 2**: Generate the actual image based on the text description

This gives the AI time to "think" before drawing.

---

## Implementation Priority

### High Priority (Must Fix)
- [ ] Simplify the step image prompt structure
- [ ] Emphasize reference image matching at the TOP of the prompt
- [ ] Reduce category rules to essential 10-15 lines

### Medium Priority (Should Fix)
- [ ] Add color palette extraction from master image
- [ ] Add step context chain for consistency
- [ ] Improve "thinking mode" utilization

### Low Priority (Nice to Have)
- [ ] Two-stage generation with text planning
- [ ] User feedback loop for regeneration
- [ ] Style transfer from master to steps

---

## Specific Code Changes

### Change 1: Restructure `generateStepImage` Prompt

Location: [geminiService.ts:694-815](services/geminiService.ts#L694-L815)

**Current Flow:**
1. Long preamble about multi-panel format
2. Analysis questions (buried)
3. Category rules (100+ lines)
4. Prohibitions
5. Final reminders

**New Flow:**
1. **ANCHOR** - Reference image emphasis (5 lines)
2. **TASK** - Clear, simple instruction (3 lines)
3. **FORMAT** - Panel layout (10 lines)
4. **RULES** - Short, essential rules (10 lines)
5. **CATEGORY** - Minimal category guidance (5 lines)

### Change 2: Reduce `getCategorySpecificRules` Length

Location: [geminiService.ts:202-660](services/geminiService.ts#L202-L660)

Current: ~450 lines for all 8 categories
Target: ~80 lines total (10 lines per category)

### Change 3: Add Reference Image Emphasis

Add a new helper function:
```typescript
const createReferenceAnchor = (category: CraftCategory): string => {
  return `
ðŸŽ¨ CRITICAL: Your output MUST match the reference image:
- Sample colors directly from the reference (use exact RGB values)
- Match material textures (paper grain, clay matte, fabric weave)
- Match the art style and aesthetic
- This is ${category} - materials should look like ${getCategoryMaterial(category)}
`;
};
```

---

## Testing Strategy

1. **Test with Simple Craft**: "Clay turtle" - should produce matching green clay
2. **Test with Complex Craft**: "Papercraft Mario" - should match exact red/blue colors
3. **Test with Multi-Character**: "Mario and Luigi" - should focus on specified character

---

## Expected Outcomes

After fixes:
1. Step images will match master image colors (within 10% RGB variance)
2. Step images will show ONLY the components for that specific step
3. Multi-panel format will be consistent across steps
4. Category-appropriate materials will be shown (paper for papercraft, clay for clay, etc.)

---

## Review Section

### Changes Summary
*(To be filled after implementation)*

### Files Modified
- `services/geminiService.ts`

### Testing Results
*(To be filled after testing)*
